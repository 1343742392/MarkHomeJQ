import{request}from"./request.js";import{setCookie,getCookie,clearCookie}from"./cookie-tool.js";import{utf8decode}from"./utf8.js";let url="",markBooks={forEachFile:function(back){this.forEachFolder(folder=>{for(let index in folder.files)back(folder.files[index])})},forEachFolder:function(back){Object.keys(markBooks).forEach(folderName=>{back(markBooks[folderName])})},deleteAll:function(){let mbkes=Object.keys(markBooks);for(let i=0;i<mbkes.length;i++)delete markBooks[mbkes[i]]}};Object.defineProperty(markBooks,"forEachFile",{writable:!1,enumerable:!1}),Object.defineProperty(markBooks,"forEachFolder",{writable:!1,enumerable:!1}),Object.defineProperty(markBooks,"deleteAll",{writable:!1,enumerable:!1});let mbLeft=null,foldersDiv=null,activeFolder=null,deleteing=!1,searchEngine="baidu",searchBtn=null,searchWordInput=null,engineUrls={kuake:"https://quark.sm.cn/s?q=",bing:"https://cn.bing.com/search?q=",google:"https://www.google.com/search?q=",baidu:"https://www.baidu.com/s?ie=UTF-8&wd="},engineBtns={},folderHtml='\n<div class="folder row w-100 click-pointer " title=\'{{fullName}}\'>\n    <p class="folder-name">{{name}}</p>\n    <svg  class="folder-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">\n        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>\n    </svg>\n\n    <button type="button" class="del-btn btn btn-sm btn-danger"  title=\'{{fullName}}\' style=\'display:none\'>\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#fff" class="bi bi-trash3" viewBox="0 0 16 16">\n            <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>\n        </svg>\n    </button>\n</div>\n',filesDiv=null,fileHtml='\n<div  class="\nfile-row \nclick-pointer \nflex-md-row \nalign-items-center " title=\'{{url}}\' >\n    <div class="file-left">\n        <img class=\'file-ico\' src=\'{{icon}}\' onerror="src=\'/static/icons/defIcon.png\'"\n        >\n    </div>\n\n    <div class="file-right">\n        <p class="file-name one-line">{{name}}</p>\n    </div>\n\n    <button type="button" class="del-btn btn btn-sm btn-danger" onclick=\'window.delFile(this);\'  title = {{i}} style=\'display:none\'>\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#fff" class="bi bi-trash3" viewBox="0 0 16 16">\n            <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>\n        </svg>\n    </button>\n</div>\n',mBsHtml='\n<!DOCTYPE NETSCAPE-Bookmark-file-1>\n<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">\n<TITLE>Bookmarks</TITLE>\n<H1>Bookmarks</H1>\n<DL><p>\n    {{folders}}\n</DL><p>\n',mBsFolderHtml='\n<DT><H3 ADD_DATE="1640677859" LAST_MODIFIED="1675407235" PERSONAL_TOOLBAR_FOLDER="true">{{folderName}}</H3>\n    <DL><p>\n',mBsfileHtml='\n<DT><A HREF="{{url}}" ADD_DATE="1664288136" > {{name}}</A>\n',loginPage=null,mailInput=null,verifBtn=null,verifCodeInput=null,loginOrRegBtn=null,homePage=null,userPage=null,userMailP=null,userMail=null,userToken=null,addUrlInput=null,addNameInput=null,folderNameInput=null,folderSelectDiv=null,folderSelectHtml='\n<a class="dropdown-item" >{{folderName}}</a>\n',addFileBtn=null,dialogDiv=null,dailogTitleH=null,dialogMsgP=null,dialogCloseBtn=null,dialogCloseAb=!0,pageList=[];function showInfo(title,info,closeAble=!0){dialogDiv.fadeIn(),dailogTitleH.text(title),dialogMsgP.text(info),dialogCloseAb=closeAble,closeAble||dialogCloseBtn.hide()}function hideInfo(forceClose=!1){dialogCloseAb|forceClose&&dialogDiv.fadeOut()}function switchPage(objPage){pageList[pageList.length-1].hide(),objPage.show(),pageList.push(objPage)}function back(){deleteing&&(deleteing=!1,$("#homeHeadDiv").show(),$("#searchDiv").show(),$("#homeBackBtn").hide(),activeFolder&&markBooks[activeFolder].folderDiv.children().last().hide(),markBooks.forEachFile(file=>{file.fileDiv.children().last().hide()})),pageList.length>1&&(pageList[pageList.length-1].hide(),pageList.pop(),pageList[pageList.length-1].show(),pageList[pageList.length-1]==homePage&&setFolderMargin())}function sendVerif(){/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(mailInput.val())?request("mail="+encodeURIComponent(mailInput.val()),url+"/index.php/index/index/sendMail",function(res){let mapRes=JSON.parse(res.currentTarget.response);401!=mapRes.code?200==mapRes.code&&(verifBtn.attr("disabled",!0),setTimeout(()=>{verifBtn.attr("disabled",!1)},3e4)):showInfo("发送验证码失败","网络问题或者服务器故障")},"post"):showInfo("输入错误","邮箱格式不对或者为空")}function selectEngine(data){let nextEngine=data.currentTarget.id;engineBtns[searchEngine].removeAttr("disabled"),engineBtns[searchEngine].click(selectEngine),engineBtns[nextEngine].prop("disabled","true"),engineBtns[nextEngine].click(null),searchEngine=nextEngine,setCookie("engine",nextEngine,999),console.log(data)}function regOrReg(){let mail=mailInput.val(),code=verifCodeInput.val();mail&&code?/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(mail)?request(`mail=${mail}&code=${code}`,url+"/index.php/index/index/LoginOrRegister",function(res){let mapRes=JSON.parse(res.currentTarget.response);200==mapRes.code?(setCookie("mail",mail,100),userMailP.text(mail),setCookie("token",mapRes.token,100),userToken=mapRes.token,"data"in mapRes&&(importFiles(mapRes.data),saveMarkBook(),clickFirst()),loginPage.hide(),homePage.show()):401==mapRes.code&&showInfo("验证失败",mapRes.data)},"post"):showInfo("输入错误","邮箱格式不对"):showInfo("输入错误","邮箱或者验证码没填")}function findE(){loginPage=$("#loginPage"),mailInput=$("#mailInput"),verifBtn=$("#verifBtn"),verifCodeInput=$("#verifCodeInput"),loginOrRegBtn=$("#loginOrRegBtn"),homePage=$("#homePage"),userPage=$("#userPage"),userMailP=$("#userMailP"),dialogDiv=$("#dialogDiv"),dailogTitleH=$("#dailogTitleH"),dialogMsgP=$("#dialogMsgP"),dialogCloseBtn=$("#dialogCloseBtn"),mbLeft=$("#mb-left"),foldersDiv=$("#foldersDiv"),filesDiv=$("#filesDiv"),addUrlInput=$("#addUrlInput"),addNameInput=$("#addNameInput"),folderNameInput=$("#folderNameInput"),folderSelectDiv=$("#folderSelectDiv"),addFileBtn=$("#addFileBtn"),searchBtn=$("#searchBtn"),searchWordInput=$("#searchWordInput")}function search(){window.open(engineUrls[searchEngine]+searchWordInput.val(),"newwindow"+searchWordInput.val())}function setEvent(){verifBtn.click(sendVerif),dialogCloseBtn.click(hideInfo),dialogDiv.click(hideInfo),loginOrRegBtn.click(regOrReg),window.back=back,window.delFile=delFile,addFileBtn.click(function(){addFile()}),$("#setSvg").click(function(obj){switchPage($("#setPage"))}),searchBtn.click(()=>{search()}),searchWordInput.keydown(function(e){13==e.which&&search()}),$("#userSvg").click(function(){switchPage(userPage)}),$("#loginOutBtn").click(function(){pageList.pop(),userPage.hide(),loginPage.show(),foldersDiv.html(""),filesDiv.html(""),markBooks.deleteAll(),clearCookie("mail"),clearCookie("token"),window.localStorage.removeItem("mark_books"),activeFolder=""}),$("#addBtn").click(function(){setSelect(),switchPage($("#addPage"))}),$("#delBtn").click(function(){deleteing=!0,markBooks.forEachFile(file=>{file.fileDiv.children().last().show()}),activeFolder&&markBooks[activeFolder].folderDiv.children().last().show(),switchPage(homePage),$("#homeHeadDiv").hide(),$("#searchDiv").hide(),$("#homeBackBtn").show()}),$("#favoritesInput").change(data=>{importHtmlMB(data)}),$("#outputBtn").click(()=>{outputHtmlMB()}),$("#engineBtn").click(function(){switchPage($("#enginePage")),Object.keys(engineUrls).forEach(key=>{engineBtns[key]=$("#"+key),key!=searchEngine?engineBtns[key].click(selectEngine):engineBtns[key].prop("disabled"," true")})})}function saveMarkBook(){window.localStorage.mark_books=encodeURIComponent(JSON.stringify(markBooks,function(k,v){return"folderDiv"==k|"fileDiv"==k|"ico"==k|"create_time"==k|"user"==k|"update_time"==k?void 0:v}))}function delFile(obj){return request(`token=${userToken}&i=${obj.title}`,url+"/index.php/index/index/delMarkBook",function(res){let mapRes=JSON.parse(res.currentTarget.response);"code"in mapRes&200==mapRes.code&&(obj.parentElement.remove(),Object.keys(markBooks).forEach(key=>{let files=markBooks[key].files;for(let index in files)if(files[index].i==obj.title)return void files.splice(index,1)}),saveMarkBook(),showInfo("删除成功","删除书签成功"))},"post"),!1}function delFolder(obj){let folderName=obj.currentTarget.title;request(`token=${userToken}&name=${folderName}`,url+"/index.php/index/index/delFolder",function(res){let resMap=JSON.parse(res.currentTarget.response);if("code"in resMap&"200"==resMap.code){obj.currentTarget.parentElement.remove();let files=markBooks[folderName].files;for(let index in files)files[index].fileDiv.remove();delete markBooks[folderName],activeFolder=null,clickFirst(),setFolderMargin(),saveMarkBook()}},"post")}function addFolder(name="其他"){let width=0,displayName=name;for(let i=0;i<name.length;i++){if((width+=name.charCodeAt(i)<=127?1.1:2)>8){displayName=name.substring(0,i-1);break}}let thisFolderHtml=folderHtml.replace(/\{\{fullName\}\}/g,name);foldersDiv.append(thisFolderHtml.replace("{{name}}",displayName));let folderDiv=foldersDiv.children().last();markBooks[name]={folderDiv:folderDiv,files:[]},folderDiv.click(folderClick),folderDiv.children().last().click(delFolder),setFolderMargin()}function folderClick(obj){let clickFolderName=obj.currentTarget.title;if(activeFolder){let activeFolderDiv=markBooks[activeFolder].folderDiv;activeFolderDiv.css("backgroundColor","#eee"),activeFolderDiv.children().first().next().show(),deleteing&&activeFolderDiv.children().last().hide();let index=null,files=markBooks[activeFolder].files;for(index in files)files[index].fileDiv.hide()}let index=null,files=markBooks[clickFolderName].files;for(index in files){files[index].fileDiv[0].style.display="flex"}return activeFolder=clickFolderName,obj.currentTarget.style.backgroundColor="#fff",obj.currentTarget.firstElementChild.nextElementSibling.style.display="none",deleteing&&(obj.currentTarget.lastElementChild.style.display="block"),!0}function fileClick(obj){"svg"==obj.target.localName|"button"==obj.target.localName|"path"==obj.target.localName||window.open(obj.currentTarget.getAttribute("title"),"newwindow"+obj.currentTarget.getAttribute("title"))}function addFile(){let addUrl=addUrlInput.val(),name=addNameInput.val(),folder=folderNameInput.val();addUrl&&name&&folder?(name.length>100&&(name=name.substring(0,100)),folder.length>100&&(folder=folder.substring(0,100)),addUrl.length>2e3&&(addUrl=addUrl.substring(0,2e3)),0==addUrl.indexOf("http")?userToken&&request(`url=${addUrl}&name=${name}&folder=${folder}&token=${userToken}`,url+"/index.php/index/index/addMarkBook",function(res){let mapRes=JSON.parse(res.currentTarget.response);if(200==mapRes.code){let file={url:addUrl,name:name,folder:folder,i:mapRes.data.i};folder in markBooks||addFolder(folder),markBooks[folder].files.push(mapRes.data),addFileView(folder,file),saveMarkBook(),showInfo("添加成功","添加书签成功"),addUrlInput.val(""),addNameInput.val(""),folderNameInput.val("")}},"post"):showInfo("填写错误","网址要填写完整包括http(s)://...")):showInfo("填写错误","网址 名字 收藏文件 不能为空")}function addFileView(folderName,file){let url=file.url,host=url.replace(url.replace(/(http|https):\/\/(www.)?(\w+(\.)?)+/,""),""),thisFileHtml=fileHtml.replace("{{icon}}",host+"/favicon.ico");thisFileHtml=(thisFileHtml=(thisFileHtml=(thisFileHtml=thisFileHtml.replaceAll("{{name}}",file.name)).replace("{{i}}",file.i)).replace("{{folder}}",folderName)).replace("{{url}}",file.url),filesDiv.append(thisFileHtml);let fileDiv=filesDiv.children().last(),color=markBooks[folderName].folderDiv[0].style.backgroundColor;""!=color&&"rgb(238, 238, 238)"!=color||fileDiv.hide(),markBooks[folderName].files[markBooks[folderName].files.length-1].fileDiv=fileDiv,filesDiv.children().last().click(fileClick),setFolderMargin()}function parseMarkBooks(importMB){let show=!1,folders=[];folders.push("其他");let files=[],href="",tagName="";const parser=new htmlparser.Parser({onopentag(name,attributes){tagName=name,"h3"===name&&"last_modified"in attributes?show=!0:"a"===name&&"href"in attributes?(href=attributes.href,show=!0):show=!1},ontext(text){show&&text.trim()&&("h3"==tagName&&folders.push(text),"a"==tagName&&(files.push({name:text,url:href,folder:folders[folders.length-1]}),tagName=""))},onclosetag(tagName){"dl"==tagName&&folders.pop()}});return parser.write(importMB),parser.end(),files}function sync(){var feature="";let keysSorted=Object.keys(markBooks).sort();for(let i=0;i<keysSorted.length;i++){feature+=keysSorted[i];let files=markBooks[keysSorted[i]].files;files=files.sort(function(a,b){return a.i-b.i});for(let i2=0;i2<files.length;i2++)feature+=files[i2].name}return feature=MD5(feature),request("mail="+userMail+"&token="+userToken+"&feature="+feature,url+"/index.php/index/index/sync",function(res){let mapRes=JSON.parse(res.currentTarget.response);if("code"in mapRes&"data"in mapRes&"200"==mapRes.code){markBooks.deleteAll(),foldersDiv.html(""),filesDiv.html(""),importFiles(mapRes.data),saveMarkBook(),console.log("sync"),clickFirst()}},"post"),feature}function importHtmlMB(data){var file=data.target.files[0];if(file){var reader=new FileReader;reader.readAsDataURL(file),reader.onload=function(evt){let text=this.result.replace(/^[^,]*,/,""),files=parseMarkBooks(utf8decode(window.atob(text)));if(0==files.length)return void showInfo("导入结果","未在该文件发现书签,请选择浏览器导出的HTML文件",!0);let strFiles=encodeURIComponent(JSON.stringify(files));showInfo("正在导入","正在导入书签需要一会",!1),request(`token=${userToken}&files=${strFiles}`,url+"/index.php/index/index/addMarkBooks",function(res){let mapRes=JSON.parse(res.currentTarget.response);if("code"in mapRes&"data"in mapRes&"200"==mapRes.code){return importFiles(mapRes.data),saveMarkBook(),clickFirst(),void showInfo("导入成功","成功导入!")}showInfo("导入失败","导入失败!")},"post")}}}function importFiles(inputMB){for(let i=0;i<inputMB.length;i++){let folderName=inputMB[i].folder;folderName in markBooks||(addFolder(folderName),setFolderMargin()),markBooks[folderName].files.push(inputMB[i]),addFileView(folderName,inputMB[i])}}function outputHtmlMB(){let strFolder="";Object.keys(markBooks).forEach(key=>{strFolder+=mBsFolderHtml.replace("{{folderName}}",key);let files=markBooks[key].files;for(let index in files){let strFile=mBsfileHtml.replace("{{url}}",files[index].url);strFile=strFile.replace("{{name}}",files[index].name),strFolder+=strFile}strFolder+="\n        </DL><p>\n\n        "});const stringData=mBsHtml.replace("{{folders}}",strFolder),blob=new Blob([stringData],{type:"text/plain;charset=utf-8"}),objectURL=URL.createObjectURL(blob),aTag=document.createElement("a");aTag.href=objectURL,aTag.download="markbook.html",aTag.click(),URL.revokeObjectURL(objectURL),showInfo("导出成功","书签已经全部导出  下载完成！")}function clickFirst(){let keys=Object.keys(markBooks);keys.length>0&&markBooks[keys[0]].folderDiv.trigger("click")}function setFolderMargin(){if("none"==homePage.css("display"))return;let mbLeftH=mbLeft.height(),foldersDivH=foldersDiv.height();foldersDivH<mbLeftH?foldersDiv.css("margin-top",mbLeftH-foldersDivH+"px"):foldersDiv.css("margin-top","unset")}function setSelect(){folderSelectDiv.html(""),Object.keys(markBooks).forEach(key=>{folderSelectDiv.append(folderSelectHtml.replace("{{folderName}}",key)),folderSelectDiv.children().last().click(()=>{folderNameInput.val(key)})})}$(document).ready(function(){if(findE(),pageList.push(homePage),setEvent(),userToken=getCookie("token"),!(userMail=getCookie("mail")))return loginPage.show(),void homePage.hide();userMailP.text(userMail),setCookie("mail",userMail,100),setCookie("token",userToken,100);let strMB=window.localStorage.mark_books;if(!!strMB&!!getCookie("mail")){var thisMarkBooks=JSON.parse(decodeURIComponent(strMB));Object.keys(thisMarkBooks).forEach(key=>{importFiles(thisMarkBooks[key].files)})}sync(),(searchEngine=getCookie("engine"))?setCookie("engine",searchEngine,999):searchEngine="baidu",searchEngine in engineUrls||(searchEngine="baidu"),clickFirst(),setFolderMargin()}),window.onresize=function(){setFolderMargin()},window.onerror=function(errorMessage,scriptURI,lineNumber,columnNumber,errorObj){let stack="";if(errorObj&&errorObj.stack)stack=errorObj.stack.toString();else if(arguments.callee){for(var ext=[],f=arguments.callee.caller,c=3;f&&--c>0&&(ext.push(f.toString()),f!==f.caller);)f=f.caller;ext=ext.join(","),stack=errorObj.stack.toString()}let errInfo="  browser: "+window.navigator.userAgent+" errMsg: "+errorMessage+"  in: "+scriptURI+"  lineNum: "+lineNumber+" any: "+stack;request(`mail=${userMail}&info=${errInfo}`,"/index.php/index/index/jsError",function(data){},"post")};