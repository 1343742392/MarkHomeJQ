import{request}from"./request.js";import{setCookie,getCookie,clearCookie}from"./cookie-tool.js";import{utf8decode}from"./utf8.js";let url="",markBooks={forEachFile:function(e){this.forEachFolder(t=>{let n=0;for(let l in t.files)if(n=e(t.files[l]))return 1})},forEachFolder:function(e){let t=0,n=Object.keys(markBooks);for(let l=0;l<n.length;l++)if(t=e(markBooks[n[l]]))return 1},deleteAll:function(){let e=Object.keys(markBooks);for(let t=0;t<e.length;t++)delete markBooks[e[t]]}};Object.defineProperty(markBooks,"forEachFile",{writable:!1,enumerable:!1}),Object.defineProperty(markBooks,"forEachFolder",{writable:!1,enumerable:!1}),Object.defineProperty(markBooks,"deleteAll",{writable:!1,enumerable:!1});let mbLeft=null,foldersDiv=null,activeFolder=null,homeState="ide",searchEngine="baidu",searchBtn=null,searchWordInput=null,engineUrls={kuake:"https://quark.sm.cn/s?q=",bing:"https://cn.bing.com/search?q=",google:"https://www.google.com/search?q=",baidu:"https://www.baidu.com/s?ie=UTF-8&wd="},engineBtns={},folderHtml='\n<div class="folder row w-100 click-pointer " \'>\n    <p class="folder-name">{{name}}</p>\n    <svg  class="folder-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">\n        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>\n    </svg>\n\n    <button type="button" class="del-btn btn btn-sm btn-danger"  style=\'display:none\'>\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#fff" class="bi bi-trash3" viewBox="0 0 16 16">\n            <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>\n        </svg>\n    </button>\n</div>\n',filesDiv=null,fileHtml='\n<div  class="\nfile-row \nclick-pointer \nflex-md-row \nalign-items-center " title=\'{{url}}\' >\n    <div class="file-left">\n        <img class=\'file-ico\' src=\'{{icon}}\' onerror="src=\'/static/icons/defIcon.png\'"\n        >\n    </div>\n\n    <div class="file-right">\n        <p class="file-name one-line">{{name}}</p>\n    </div>\n\n    <button type="button" class="del-btn btn btn-sm btn-danger" onclick=\'window.delFile(this);\'  title = {{i}} style=\'display:none\'>\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#fff" class="bi bi-trash3" viewBox="0 0 16 16">\n            <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>\n        </svg>\n    </button>\n</div>\n',mBsHtml='\n<!DOCTYPE NETSCAPE-Bookmark-file-1>\n<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">\n<TITLE>Bookmarks</TITLE>\n<H1>Bookmarks</H1>\n<DL><p>\n    {{folders}}\n</DL><p>\n',mBsFolderHtml='\n<DT><H3 ADD_DATE="1640677859" LAST_MODIFIED="1675407235" PERSONAL_TOOLBAR_FOLDER="true">{{folderName}}</H3>\n    <DL><p>\n',mBsfileHtml='\n<DT><A HREF="{{url}}" ADD_DATE="1664288136" > {{name}}</A>\n',loginPage=null,mailInput=null,verifBtn=null,verifCodeInput=null,loginOrRegBtn=null,homePage=null,userPage=null,userMailP=null,userMail=null,userToken=null,addUrlInput=null,addNameInput=null,folderNameInput=null,folderSelectDiv=null,folderSelectHtml='\n<a class="dropdown-item" >{{folderName}}</a>\n',addFileBtn=null,editFolderPage=null,editFilePage=null,editFileId=null,dialogDiv=null,dailogTitleH=null,dialogMsgP=null,dialogCloseBtn=null,dialogCloseAb=!0,pageList=[];function showInfo(e,t,n=!0){dialogDiv.fadeIn(),dailogTitleH.text(e),dialogMsgP.text(t),dialogCloseAb=n,n||dialogCloseBtn.hide()}function hideInfo(e=!1){dialogCloseAb|e&&dialogDiv.fadeOut()}function switchPage(e){e!=editFilePage&&e!=editFolderPage||(homeState="editing"),pageList[pageList.length-1].hide(),e.show(),pageList.push(e)}function back(){"del"!=homeState&&"edit"!=homeState||($("#homeHeadDiv").show(),$("#searchDiv").show(),$("#homeBackBtn").hide(),activeFolder&&markBooks[activeFolder].folderDiv.children().last().hide(),markBooks.forEachFile(e=>{e.fileDiv.children().last().hide()}),homeState="ide"),"editing"==homeState&&($("#homeBackBtn").show(),homeState="edit"),pageList.length>1&&(pageList[pageList.length-1].hide(),pageList.pop(),pageList[pageList.length-1].show(),pageList[pageList.length-1]==homePage&&setFolderMargin())}function sendVerif(){/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(mailInput.val())?request("mail="+encodeURIComponent(mailInput.val()),url+"/index.php/index/index/sendMail",function(e){let t=JSON.parse(e.currentTarget.response);401!=t.code?200==t.code&&(verifBtn.attr("disabled",!0),setTimeout(()=>{verifBtn.attr("disabled",!1)},3e4)):showInfo("发送验证码失败","网络问题或者服务器故障")},"post"):showInfo("输入错误","邮箱格式不对或者为空")}function selectEngine(e){let t=e.currentTarget.id;engineBtns[searchEngine].removeAttr("disabled"),engineBtns[searchEngine].click(selectEngine),engineBtns[t].prop("disabled","true"),engineBtns[t].click(null),searchEngine=t,setCookie("engine",t,999)}function regOrReg(){let e=mailInput.val(),t=verifCodeInput.val();e&&t?/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(e)?request(`mail=${e}&code=${t}`,url+"/index.php/index/index/LoginOrRegister",function(t){let n=JSON.parse(t.currentTarget.response);200==n.code?(setCookie("mail",e,100),userMailP.text(e),setCookie("token",n.token,100),userToken=n.token,switchPage(homePage),"data"in n&&(importFiles(n.data),saveMarkBook(),clickFirst())):401==n.code&&showInfo("验证失败",n.data)},"post"):showInfo("输入错误","邮箱格式不对"):showInfo("输入错误","邮箱或者验证码没填")}function findE(){loginPage=$("#loginPage"),mailInput=$("#mailInput"),verifBtn=$("#verifBtn"),verifCodeInput=$("#verifCodeInput"),loginOrRegBtn=$("#loginOrRegBtn"),homePage=$("#homePage"),userPage=$("#userPage"),editFolderPage=$("#editFolderPage"),editFilePage=$("#editFilePage"),userMailP=$("#userMailP"),dialogDiv=$("#dialogDiv"),dailogTitleH=$("#dailogTitleH"),dialogMsgP=$("#dialogMsgP"),dialogCloseBtn=$("#dialogCloseBtn"),mbLeft=$("#mb-left"),foldersDiv=$("#foldersDiv"),filesDiv=$("#filesDiv"),addUrlInput=$("#addUrlInput"),addNameInput=$("#addNameInput"),folderNameInput=$("#folderNameInput"),folderSelectDiv=$("#folderSelectDiv"),addFileBtn=$("#addFileBtn"),searchBtn=$("#searchBtn"),searchWordInput=$("#searchWordInput")}function search(){window.open(engineUrls[searchEngine]+searchWordInput.val(),"newwindow"+searchWordInput.val())}function setEvent(){verifBtn.click(sendVerif),dialogCloseBtn.click(hideInfo),dialogDiv.click(hideInfo),loginOrRegBtn.click(regOrReg),window.back=back,window.delFile=delFile,addFileBtn.click(function(){addFile()}),$("#setSvg").click(function(e){switchPage($("#setPage"))}),searchBtn.click(()=>{search()}),searchWordInput.keydown(function(e){13==e.which&&search()}),$("#userSvg").click(function(){switchPage(userPage)}),$("#loginOutBtn").click(function(){clearCookie("mail"),clearCookie("token"),window.localStorage.removeItem("mark_books"),location.reload()}),$("#addBtn").click(function(){setSelect(),switchPage($("#addPage"))}),$("#editBtn").click(function(){homeState="edit",switchPage(homePage),$("#homeHeadDiv").hide(),$("#searchDiv").hide(),$("#homeBackBtn").show()}),editFolderPage.find("button").first().click(function(){editFolder(activeFolder,editFolderPage.find("input").prop("value"))}),editFilePage.find("button").first().click(function(){editFile()}),$("#delBtn").click(function(){homeState="del",markBooks.forEachFile(e=>{e.fileDiv.children().last().show()}),activeFolder&&markBooks[activeFolder].folderDiv.children().last().show(),switchPage(homePage),$("#homeHeadDiv").hide(),$("#searchDiv").hide(),$("#homeBackBtn").show()}),$("#favoritesInput").change(e=>{importHtmlMB(e)}),$("#outputBtn").click(()=>{outputHtmlMB()}),$("#engineBtn").click(function(){switchPage($("#enginePage")),Object.keys(engineUrls).forEach(e=>{engineBtns[e]=$("#"+e),e!=searchEngine?engineBtns[e].click(selectEngine):engineBtns[e].prop("disabled"," true")})})}function saveMarkBook(){window.localStorage.mark_books=encodeURIComponent(JSON.stringify(markBooks,function(e,t){return"folderDiv"==e|"fileDiv"==e|"ico"==e|"create_time"==e|"user"==e|"update_time"==e?void 0:t}))}function editFile(){let e=$("#fileNameInput").prop("value"),t=$("#fileUrlInput").prop("value");t&&e?(e.length>100&&(e=e.substring(0,100)),t.length>2e3?showInfo("填写错误","url过长"):0==t.indexOf("http")?(markBooks.forEachFile(n=>{if(n.i==editFileId){return n.name=e,n.url=t,n.fileDiv.find("p")[0].textContent=e,n.fileDiv.attr("title",t),1}}),saveMarkBook(),request(`mail=${userMail}&token=${userToken}&id=${editFileId}&name=${e}&url=${t}`,url+"/index.php/index/index/editFile",e=>{let t=JSON.parse(e.currentTarget.response);"code"in t&"200"==t.code?showInfo("修改成功","修改成功"):showInfo("修改失败","修改失败")},"post")):showInfo("填写错误","网址要填写完整包括http(s)://...")):showInfo("填写错误","网址 名字 收藏文件 不能为空")}function editFolder(e,t){(t=t.trim())?t.length>50?showInfo("填写错误","文件名字太长了"):request(`mail=${userMail}&token=${userToken}&fromName=${e}&toName=${t}`,url+"/index.php/index/index/editFolder",e=>{let t=JSON.parse(e.currentTarget.response);"code"in t&"200"==t.code?(sync(),showInfo("修改成功","修改成功")):showInfo("修改失败","修改失败")},"post"):showInfo("填写错误","文件名字不能为空")}function delFile(e){return request(`token=${userToken}&i=${e.title}`,url+"/index.php/index/index/delMarkBook",function(t){let n=JSON.parse(t.currentTarget.response);"code"in n&200==n.code&&(e.parentElement.remove(),Object.keys(markBooks).forEach(t=>{let n=markBooks[t].files;for(let t in n)if(n[t].i==e.title)return void n.splice(t,1)}),saveMarkBook(),showInfo("删除成功","删除书签成功"))},"post"),!1}function delFolder(e){let t=e.currentTarget.parentNode.firstElementChild.textContent;request(`token=${userToken}&name=${t}`,url+"/index.php/index/index/delFolder",function(n){let l=JSON.parse(n.currentTarget.response);if("code"in l&"200"==l.code){e.currentTarget.parentElement.remove();let n=markBooks[t].files;for(let e in n)n[e].fileDiv.remove();delete markBooks[t],activeFolder=null,clickFirst(),setFolderMargin(),saveMarkBook()}},"post")}function addFolder(e="其他"){foldersDiv.append(folderHtml.replace("{{name}}",e));let t=foldersDiv.children().last();markBooks[e]={folderDiv:t,files:[]},t.click(folderClick),t.children().last().click(delFolder),setFolderMargin()}function switchFolder(e){let t=null,n=markBooks[e].files;for(t in n)n[t].fileDiv.toggle();let l=markBooks[e].folderDiv;""==l[0].style.backgroundColor?l[0].style.backgroundColor="#fff":l[0].style.backgroundColor="";let i=l[0].firstElementChild.nextElementSibling;if("none"==i.style.display?i.style.display="block":i.style.display="none","del"==homeState){let e=l[0].lastElementChild;""==e.style.display?e.style.display="none":e.style.display=""}}function folderClick(e){let t=e.currentTarget.firstElementChild.textContent;activeFolder!=t?(activeFolder&&switchFolder(activeFolder),switchFolder(t),activeFolder=t):"edit"==homeState&&(editFolderPage.find("input").prop("value",t),switchPage(editFolderPage))}function fileClick(e){if(!("svg"==e.target.localName|"button"==e.target.localName|"path"==e.target.localName))if("edit"==homeState){let t=e.currentTarget.firstElementChild.nextElementSibling.textContent.trim(),n=e.currentTarget.getAttribute("title");editFileId=Number(e.currentTarget.lastElementChild.getAttribute("title")),$("#fileNameInput").prop("value",t),$("#fileUrlInput").prop("value",n),switchPage(editFilePage)}else window.open(e.currentTarget.getAttribute("title"),"newwindow"+e.currentTarget.getAttribute("title"))}function addFile(){let e=addUrlInput.val().trim(),t=addNameInput.val().trim(),n=folderNameInput.val().trim();e&&t&&n?(t.length>100&&(t=t.substring(0,100)),n.length>100&&(n=n.substring(0,100)),e.length>2e3?showInfo("填写错误","url过长"):0==e.indexOf("http")?userToken&&request(`url=${e}&name=${t}&folder=${n}&token=${userToken}`,url+"/index.php/index/index/addMarkBook",function(l){let i=JSON.parse(l.currentTarget.response);if(200==i.code){let l={url:e,name:t,folder:n,i:i.data.i};n in markBooks||addFolder(n),markBooks[n].files.push(i.data),addFileView(n,l),saveMarkBook(),showInfo("添加成功","添加书签成功"),addUrlInput.val(""),addNameInput.val(""),folderNameInput.val("")}},"post"):showInfo("填写错误","网址要填写完整包括http(s)://...")):showInfo("填写错误","网址 名字 收藏文件 不能为空")}function addFileView(e,t){let n=t.url,l=n.replace(n.replace(/(http|https):\/\/(www.)?(\w+(\.)?)+/,""),""),i=fileHtml.replace("{{icon}}",l+"/favicon.ico");i=(i=(i=i.replaceAll("{{name}}",t.name)).replace("{{i}}",t.i)).replace("{{url}}",t.url),filesDiv.append(i);let o=filesDiv.children().last(),r=markBooks[e].folderDiv[0].style.backgroundColor;""!=r&&"rgb(238, 238, 238)"!=r||o.hide(),markBooks[e].files[markBooks[e].files.length-1].fileDiv=o,filesDiv.children().last().click(fileClick),setFolderMargin()}function parseMarkBooks(e){let t=!1,n=[];n.push("其他");let l=[],i="",o="";const r=new htmlparser.Parser({onopentag(e,n){o=e,"h3"===e&&"last_modified"in n?t=!0:"a"===e&&"href"in n?(i=n.href,t=!0):t=!1},ontext(e){t&&("h3"==o&&(""!=e.trim()?n.push(e):n.push("未命名")),"a"==o&&(n[n.length-1]||console.log("error"),""==e.trim()&&(e="未命名"),l.push({name:e,url:i,folder:n[n.length-1]}),o=""),t=!1)},onclosetag(e){"dl"==e&&n.pop()}});return r.write(e),r.end(),l}function sync(){var e="";let t=Object.keys(markBooks).sort();for(let n=0;n<t.length;n++){e+=t[n];let l=markBooks[t[n]].files;l=l.sort(function(e,t){return e.i-t.i});for(let t=0;t<l.length;t++)e+=l[t].name}return e=MD5(e),request("mail="+userMail+"&token="+userToken+"&feature="+e,url+"/index.php/index/index/sync",function(e){let t=JSON.parse(e.currentTarget.response);if("code"in t&"data"in t&"200"==t.code){markBooks.deleteAll(),foldersDiv.html(""),filesDiv.html(""),activeFolder=null,importFiles(t.data),saveMarkBook(),console.log("sync"),clickFirst()}},"post"),e}function importHtmlMB(e){var t=e.target.files[0];if(t){var n=new FileReader;n.readAsDataURL(t),n.onload=function(e){let t=this.result.replace(/^[^,]*,/,""),n=parseMarkBooks(utf8decode(window.atob(t)));if(0==n.length)return void showInfo("导入结果","未在该文件发现书签,请选择浏览器导出的HTML文件",!0);let l=encodeURIComponent(JSON.stringify(n));showInfo("正在导入","正在导入书签需要一会",!1),request(`token=${userToken}&files=${l}`,url+"/index.php/index/index/addMarkBooks",function(e){let t=JSON.parse(e.currentTarget.response);if("code"in t&"data"in t&"200"==t.code){return importFiles(t.data),saveMarkBook(),clickFirst(),void showInfo("导入成功","成功导入!")}showInfo("导入失败","导入失败!")},"post")}}}function importFiles(e){for(let t=0;t<e.length;t++){let n=e[t].folder;n in markBooks||(addFolder(n),setFolderMargin()),markBooks[n].files.push(e[t]),addFileView(n,e[t])}}function outputHtmlMB(){let e="";Object.keys(markBooks).forEach(t=>{e+=mBsFolderHtml.replace("{{folderName}}",t);let n=markBooks[t].files;for(let t in n){let l=mBsfileHtml.replace("{{url}}",n[t].url);l=l.replace("{{name}}",n[t].name),e+=l}e+="\n        </DL><p>\n\n        "});const t=mBsHtml.replace("{{folders}}",e),n=new Blob([t],{type:"text/plain;charset=utf-8"}),l=URL.createObjectURL(n),i=document.createElement("a");i.href=l,i.download="markbook.html",i.click(),URL.revokeObjectURL(l),showInfo("导出成功","书签已经全部导出  下载完成！")}function clickFirst(){let e=Object.keys(markBooks);e.length>0&&markBooks[e[0]].folderDiv.trigger("click")}function setFolderMargin(){if("none"==homePage.css("display"))return;let e=mbLeft.height(),t=foldersDiv.height();t<e?foldersDiv.css("margin-top",e-t+"px"):foldersDiv.css("margin-top","unset")}function setSelect(){folderSelectDiv.html(""),Object.keys(markBooks).forEach(e=>{folderSelectDiv.append(folderSelectHtml.replace("{{folderName}}",e)),folderSelectDiv.children().last().click(()=>{folderNameInput.val(e)})})}$(document).ready(function(){if(findE(),pageList.push(homePage),setEvent(),userToken=getCookie("token"),!(userMail=getCookie("mail")))return void switchPage(loginPage);userMailP.text(userMail),setCookie("mail",userMail,100),setCookie("token",userToken,100);let e=window.localStorage.mark_books;if(!!e&!!getCookie("mail")){var t=JSON.parse(decodeURIComponent(e));Object.keys(t).forEach(e=>{importFiles(t[e].files)})}sync(),(searchEngine=getCookie("engine"))?setCookie("engine",searchEngine,999):searchEngine="baidu",searchEngine in engineUrls||(searchEngine="baidu"),clickFirst(),setFolderMargin()}),window.onresize=function(){setFolderMargin()},window.onerror=function(e,t,n,l,i){let o="";if(i&&i.stack)o=i.stack.toString();else if(arguments.callee){for(var r=[],a=arguments.callee.caller,s=3;a&&--s>0&&(r.push(a.toString()),a!==a.caller);)a=a.caller;r=r.join(","),o=i.stack.toString()}let d="  browser: "+window.navigator.userAgent+" errMsg: "+e+"  in: "+t+"  lineNum: "+n+" any: "+o;request(`mail=${userMail}&info=${d}`,"/index.php/index/index/jsError",function(e){},"post")};